<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress VRT with Playwright</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.success {
            background: #28a745;
        }
        
        .button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .screenshot-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .screenshot-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .screenshot-item h4 {
            margin: 10px 0 5px;
            color: #333;
        }
        
        .screenshot-item p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .diff-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .diff-info h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .diff-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .diff-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .diff-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .diff-stat .label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .api-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .api-info h3 {
            margin-bottom: 15px;
            color: #1976d2;
        }
        
        .api-endpoint {
            background: #263238;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 WordPress VRT with Playwright</h1>
            <p>高精度ピクセル単位の見た目差分検出システム</p>
        </div>

        <div class="card">
            <h2>🌐 複数サイトVRTチェック</h2>
            <form id="vrtForm">
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label>🌐 対象サイト選択</label>
                            <div style="margin: 10px 0;">
                                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="selectAllSites" onchange="toggleAllSites()" style="margin-right: 8px; transform: scale(1.2);">
                                        <span style="font-weight: 600; color: #667eea;">全サイト選択</span>
                                    </label>
                                    <span id="selectedSitesCount" style="color: #666; font-size: 0.9em;">0サイト選択中</span>
                                </div>
                            </div>
                            <div id="siteCheckboxList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 6px; padding: 10px; background: #f8f9fa;">
                                <!-- サイトのチェックボックスがここに動的に追加される -->
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                チェックボックスで複数サイトを選択できます
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="executionMode">🚀 実行モード</label>
                            <select id="executionMode" name="executionMode">
                                <option value="step1-only">Step1: 更新前撮影のみ</option>
                                <option value="step2-and-3" selected>Step2+3: 撮影→即座に比較</option>
                                <option value="step3-only">Step3: 比較のみ</option>
                                <option value="full-workflow">フルワークフロー</option>
                                <option value="crawl-only">クロールのみ（URL収集）</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="crawlMode">🕷️ クロール設定</label>
                            <select id="crawlMode" name="crawlMode">
                                <option value="auto">自動クロール（全ページ収集）</option>
                                <option value="single">単一ページ（トップのみ）</option>
                                <option value="manual">手動URL指定</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label>📱 対象デバイス</label>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" name="devices" value="desktop" checked>
                                    デスクトップ
                                </label>
                                <label>
                                    <input type="checkbox" name="devices" value="mobile">
                                    モバイル
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="threshold">🎯 差分闾値 (%)</label>
                            <input type="number" id="threshold" name="threshold" value="2.0" step="0.1" min="0.1" max="10.0" style="width: 100px;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                変化率がこの値を超えるとNG判定
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="maxPages">📄 最大ページ数</label>
                            <input type="number" id="maxPages" name="maxPages" value="20" min="1" max="50" style="width: 100px;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                クロール時の上限ページ数
                            </small>
                        </div>
                    </div>
                </div>
                
                <div id="manualUrlSection" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label for="manualUrls">🔗 手動URL指定（一行一URL）</label>
                        <textarea id="manualUrls" name="manualUrls" rows="5" style="width: 100%; font-family: monospace;" placeholder="https://example.com/\nhttps://example.com/about\nhttps://example.com/contact"></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="button" id="executeButton">🎯 実行</button>
                    <button type="button" class="button secondary" onclick="showSiteManager()">🌐 サイト管理</button>
                    <button type="button" class="button secondary" onclick="showResults()">📈 結果確認</button>
                    <button type="button" class="button warning" onclick="refreshSites()">🔄 サイト一覧更新</button>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px;">📁 設定ファイルから読み込み</h4>
                    <p style="margin-bottom: 10px; color: #666; font-size: 0.9em;">
                        config.jsonファイルをプロジェクトルートに配置すると自動的に読み込まれます。
                    </p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="configFileInput" accept=".json" style="flex: 1;">
                        <button type="button" class="button secondary" onclick="loadConfigFile()">📂 ファイル読み込み</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <h3 style="margin-bottom: 15px; color: #555;">🔄 プラグイン更新ワークフロー（旧機能）</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button type="button" class="button secondary" onclick="takeBeforeUpdate()">
                            📸 Step 1: 更新前キャプチャ（旧）
                        </button>
                        <div style="display: flex; align-items: center; padding: 10px 15px; background: #f8f9fa; border-radius: 6px; font-weight: 500;">
                            ↓ プラグイン更新実行 ↓
                        </div>
                        <button type="button" class="button secondary" onclick="takeAfterUpdate()">
                            📸 Step 2: 更新後キャプチャ（旧）
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        ※ 上記は従来機能です。新しい複数サイト対応機能を上でご利用ください。
                    </p>
                </div>
            </form>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>VRTチェック実行中...</p>
        </div>

        <div id="results"></div>

        <!-- サイト管理モーダル -->
        <div id="siteManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div class="card" style="position: relative; max-width: 600px; margin: 50px auto; max-height: 80vh; overflow-y: auto;">
                <h3>🌐 サイト管理</h3>
                <div id="sitesList" style="margin: 20px 0;"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e5e9;">
                    <h4>新規サイト追加</h4>
                    <div class="grid">
                        <input type="text" id="newSiteId" placeholder="サイトID" style="margin-bottom: 10px;">
                        <input type="text" id="newSiteName" placeholder="サイト名" style="margin-bottom: 10px;">
                    </div>
                    <input type="url" id="newSiteUrl" placeholder="https://example.com" style="width: 100%; margin-bottom: 10px;">
                    <button class="button success" onclick="addNewSite()">🎆 サイト追加</button>
                </div>
                <button class="button secondary" onclick="closeSiteManager()" style="margin-top: 20px;">閉じる</button>
            </div>
        </div>
        
        <div class="api-info">
            <h3>📚 API エンドポイント</h3>
            <div class="api-endpoint">POST /capture-baseline - Step1 Baseline撮影</div>
            <div class="api-endpoint">POST /capture-and-compare - Step2+3統合実行</div>
            <div class="api-endpoint">POST /crawl - サイトクロール</div>
            <div class="api-endpoint">GET /results - 実行結果一覧</div>
            <div class="api-endpoint">GET /sites - サイト一覧</div>
        </div>
    </div>

    <script>
        const form = document.getElementById('vrtForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        let allSites = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSites();
            setupEventListeners();
        });

        function setupEventListeners() {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await executeVRT();
            });

            // クロールモード変更時のUI更新
            document.getElementById('crawlMode').addEventListener('change', (e) => {
                const manualSection = document.getElementById('manualUrlSection');
                manualSection.style.display = e.target.value === 'manual' ? 'block' : 'none';
            });

            // 実行モード変更時のボタンテキスト更新
            document.getElementById('executionMode').addEventListener('change', (e) => {
                updateExecuteButtonText();
            });
        }

        function updateExecuteButtonText() {
            const mode = document.getElementById('executionMode').value;
            const button = document.getElementById('executeButton');
            const modeTexts = {
                'step1-only': '📸 Step1実行',
                'step2-and-3': '🚀 Step2+3実行',
                'step3-only': '🔍 Step3実行',
                'full-workflow': '🎆 フルワークフロー実行',
                'crawl-only': '🕷️ クロール実行'
            };
            button.textContent = modeTexts[mode] || '🎯 実行';
        }

        async function loadSites() {
            try {
                const response = await fetch('/sites');
                const data = await response.json();
                
                if (data.success) {
                    allSites = data.sites;
                    updateSiteSelection();
                } else {
                    console.error('サイト一覧の取得に失敗:', data.error);
                }
            } catch (error) {
                console.error('サイト一覧の取得エラー:', error);
            }
        }

        function updateSiteSelection() {
            const checkboxList = document.getElementById('siteCheckboxList');
            const enabledSites = allSites.filter(site => site.enabled);
            
            checkboxList.innerHTML = enabledSites.map(site => {
                const lastExecution = getLastExecutionDate(site.id);
                const lastExecutionText = lastExecution ? 
                    `最終実行: ${new Date(lastExecution).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}` :
                    '未実行';
                    
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #e1e5e9;">
                        <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                            <input type="checkbox" name="siteSelection" value="${site.id}" onchange="updateSelectedCount()" style="margin-right: 10px; transform: scale(1.1);">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #333;">${site.name}</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 2px;">${site.baseUrl}</div>
                                <div style="font-size: 0.75em; color: ${lastExecution ? '#28a745' : '#6c757d'}; margin-top: 2px;">
                                    ${lastExecutionText}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateSelectedCount();
        }

        async function executeVRT() {
            const formData = new FormData(form);
            const selectedSiteCheckboxes = document.querySelectorAll('input[name="siteSelection"]:checked');
            const siteSelection = Array.from(selectedSiteCheckboxes).map(checkbox => checkbox.value);
            const executionMode = formData.get('executionMode');
            const crawlMode = formData.get('crawlMode');
            const devices = formData.getAll('devices');
            const threshold = parseFloat(formData.get('threshold'));
            const maxPages = parseInt(formData.get('maxPages'));
            const manualUrls = formData.get('manualUrls');

            if (devices.length === 0) {
                alert('少なくとも1つのデバイスを選択してください。');
                return;
            }

            if (siteSelection.length === 0) {
                alert('少なくとも1つのサイトを選択してください。');
                return;
            }

            showLoading(true);
            clearResults();

            try {
                if (executionMode === 'crawl-only') {
                    await executeCrawlOnly(siteSelection, maxPages);
                } else if (executionMode === 'step1-only') {
                    await executeStep1Only(siteSelection, devices, crawlMode, maxPages, manualUrls);
                } else if (executionMode === 'step2-and-3') {
                    await executeStep2And3(siteSelection, devices, threshold, crawlMode, maxPages, manualUrls);
                } else if (executionMode === 'step3-only') {
                    await executeStep3Only(siteSelection, devices, threshold);
                } else if (executionMode === 'full-workflow') {
                    await executeFullWorkflow(siteSelection, devices, threshold, crawlMode, maxPages, manualUrls);
                }
            } catch (error) {
                displayError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function executeCrawlOnly(siteSelection, maxPages) {
            const targetSites = siteSelection.includes('all') ? 
                allSites.filter(s => s.enabled) : 
                allSites.filter(s => siteSelection.includes(s.id) && s.enabled);

            const results = [];
            for (const site of targetSites) {
                console.log(`🕷️ ${site.id} をクロール中...`);
                
                const response = await fetch('/crawl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url: site.baseUrl, 
                        maxPages: maxPages 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    results.push({
                        siteId: site.id,
                        siteName: site.name,
                        ...data.result
                    });
                }
            }
            
            displayCrawlResults(results);
        }

        async function executeStep2And3(siteSelection, devices, threshold, crawlMode, maxPages, manualUrls) {
            const requestBody = {
                threshold: threshold,
                crawlMode: crawlMode
            };

            if (siteSelection.includes('all')) {
                requestBody.siteIds = 'all';
            } else {
                requestBody.siteIds = siteSelection;
            }

            // 手動URL指定の場合
            if (crawlMode === 'manual' && manualUrls) {
                const urls = manualUrls.split('\n').filter(url => url.trim());
                requestBody.pages = urls.map((url, index) => ({
                    url: url.trim(),
                    pageId: String(index + 1).padStart(3, '0'),
                    identifier: `manual-${index + 1}`,
                    title: `Manual URL ${index + 1}`
                }));
            }

            const results = [];
            for (const device of devices) {
                const response = await fetch('/capture-and-compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...requestBody, device })
                });
                
                const data = await response.json();
                if (data.success) {
                    results.push({ device, ...data });
                }
            }
            
            displayStep2And3Results(results);
            
            // 成功したサイトの最終実行日を保存
            siteSelection.forEach(siteId => {
                if (siteId !== 'all') {
                    saveLastExecutionDate(siteId);
                }
            });
            if (siteSelection.includes('all')) {
                allSites.filter(s => s.enabled).forEach(site => {
                    saveLastExecutionDate(site.id);
                });
            }
        }

        // Step1のみ実行（Baseline撮影）
        async function executeStep1Only(siteSelection, devices, crawlMode, maxPages, manualUrls) {
            const requestBody = {
                crawlMode: crawlMode,
                maxPages: maxPages
            };

            if (siteSelection.includes('all')) {
                requestBody.siteIds = 'all';
            } else {
                requestBody.siteIds = siteSelection;
            }

            // 手動URL指定の場合
            if (crawlMode === 'manual' && manualUrls) {
                const urls = manualUrls.split('\n').filter(url => url.trim());
                requestBody.pages = urls.map((url, index) => ({
                    url: url.trim(),
                    pageId: String(index + 1).padStart(3, '0'),
                    identifier: `manual-${index + 1}`,
                    title: `Manual URL ${index + 1}`
                }));
            }

            const results = [];
            for (const device of devices) {
                const response = await fetch('/capture-baseline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...requestBody, device })
                });
                
                const data = await response.json();
                if (data.success) {
                    results.push({ device, ...data });
                }
            }
            
            displayStep1Results(results);
            
            // 成功したサイトの最終実行日を保存
            siteSelection.forEach(siteId => {
                if (siteId !== 'all') {
                    saveLastExecutionDate(siteId);
                }
            });
            if (siteSelection.includes('all')) {
                allSites.filter(s => s.enabled).forEach(site => {
                    saveLastExecutionDate(site.id);
                });
            }
        }

        async function executeStep3Only(siteSelection, devices, threshold) {
            displayInfo('⚙️ Step3のみの実行は開発中です。Step2+3をご利用ください。');
        }

        async function executeFullWorkflow(siteSelection, devices, threshold, crawlMode, maxPages, manualUrls) {
            // Step1とStep2+3を順次実行
            await executeStep1Only(siteSelection, devices, crawlMode, maxPages, manualUrls);
            // 少し待機
            await new Promise(resolve => setTimeout(resolve, 2000));
            await executeStep2And3(siteSelection, devices, threshold, crawlMode, maxPages, manualUrls);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        function clearResults() {
            const results = document.getElementById('results');
            results.innerHTML = '';
        }

        function displayFullVRTResults(data) {
            const hasNG = data.summary && data.summary.ng > 0;
            const resultClass = hasNG ? 'warning' : 'success';
            
            results.innerHTML = `
                <div class="card">
                    <div class="result ${resultClass}">
                        <h3>🎉 フルVRTチェック完了</h3>
                        <p><strong>サイト:</strong> ${data.siteId}</p>
                        <p><strong>URL:</strong> ${data.url}</p>
                        <p><strong>判定:</strong> ${hasNG ? '⚠️ NG（差分検出）' : '✅ OK'}</p>
                    </div>
                    
                    ${data.summary ? `
                    <div class="diff-info">
                        <h4>📊 実行サマリー</h4>
                        <div class="diff-stats">
                            <div class="diff-stat">
                                <div class="value">${data.summary.total}</div>
                                <div class="label">総デバイス数</div>
                            </div>
                            <div class="diff-stat">
                                <div class="value">${data.summary.ok}</div>
                                <div class="label">OK</div>
                            </div>
                            <div class="diff-stat">
                                <div class="value">${data.summary.ng}</div>
                                <div class="label">NG</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${data.results ? data.results.map(result => `
                        <div class="diff-info">
                            <h4>📱 ${result.device} 結果</h4>
                            ${result.comparison ? `
                            <div class="diff-stats">
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.status}</div>
                                    <div class="label">判定</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.diffPercentage}%</div>
                                    <div class="label">差分率</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.diffPixels}</div>
                                    <div class="label">差分ピクセル</div>
                                </div>
                            </div>
                            ${result.comparison.diffPath ? `
                            <p><strong>差分画像:</strong> <a href="${result.comparison.diffPath}" target="_blank">表示</a></p>
                            ` : ''}
                            ` : ''}
                        </div>
                    `).join('') : ''}
                </div>
            `;
        }

        function displayComparisonResults(results) {
            const hasNG = results.some(r => r.status === 'NG');
            const resultClass = hasNG ? 'warning' : 'success';
            
            results.innerHTML = `
                <div class="card">
                    <div class="result ${resultClass}">
                        <h3>🔍 画像比較完了</h3>
                        <p><strong>判定:</strong> ${hasNG ? '⚠️ NG（差分検出）' : '✅ OK'}</p>
                    </div>
                    
                    ${results.map(result => `
                        <div class="diff-info">
                            <h4>📱 ${result.device} 比較結果</h4>
                            <div class="diff-stats">
                                <div class="diff-stat">
                                    <div class="value">${result.status}</div>
                                    <div class="label">判定</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.diffPercentage}%</div>
                                    <div class="label">差分率</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.diffPixels}</div>
                                    <div class="label">差分ピクセル</div>
                                </div>
                            </div>
                            ${result.diffPath ? `
                            <p><strong>差分画像:</strong> <a href="${result.diffPath}" target="_blank">表示</a></p>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayScreenshotResults(results, action) {
            results.innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>📸 ${action} 撮影完了</h3>
                        <p>${results.length}個のスクリーンショットを撮影しました。</p>
                    </div>
                    
                    <div class="screenshot-grid">
                        ${results.map(result => `
                            <div class="screenshot-item">
                                <h4>📱 ${result.device}</h4>
                                <p><strong>ファイル:</strong> ${result.filename}</p>
                                <p><strong>サイズ:</strong> ${(result.size / 1024 / 1024).toFixed(2)} MB</p>
                                <p><strong>時刻:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function displayError(error) {
            results.innerHTML = `
                <div class="card">
                    <div class="result error">
                        <h3>❌ エラーが発生しました</h3>
                        <p>${error}</p>
                    </div>
                </div>
            `;
        }

        async function loadScreenshots() {
            const siteId = document.getElementById('siteId').value;
            if (!siteId) {
                alert('サイトIDを入力してください。');
                return;
            }

            try {
                const response = await fetch(`/screenshots/${siteId}`);
                const data = await response.json();
                
                if (data.screenshots && data.screenshots.length > 0) {
                    results.innerHTML = `
                        <div class="card">
                            <h3>📸 スクリーンショット一覧 (${siteId})</h3>
                            <div class="screenshot-grid">
                                ${data.screenshots.map(screenshot => `
                                    <div class="screenshot-item">
                                        <img src="${screenshot.path}" alt="${screenshot.type} - ${screenshot.device}" 
                                             style="max-width: 200px; cursor: pointer;" 
                                             onclick="window.open('${screenshot.path}', '_blank')">
                                        <h4>${screenshot.type} - ${screenshot.device}</h4>
                                        <p>${new Date(screenshot.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="card">
                            <div class="result warning">
                                <h3>📸 スクリーンショットが見つかりません</h3>
                                <p>サイトID「${siteId}」のスクリーンショットがありません。</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                displayError('スクリーンショット一覧の取得に失敗しました: ' + error.message);
            }
        }

        async function loadDiffs() {
            const siteId = document.getElementById('siteId').value;
            if (!siteId) {
                alert('サイトIDを入力してください。');
                return;
            }

            try {
                const response = await fetch(`/diffs/${siteId}`);
                const data = await response.json();
                
                if (data.diffs && data.diffs.length > 0) {
                    results.innerHTML = `
                        <div class="card">
                            <h3>🔍 差分画像一覧 (${siteId})</h3>
                            <div class="screenshot-grid">
                                ${data.diffs.map(diff => `
                                    <div class="screenshot-item">
                                        <img src="${diff.path}" alt="差分画像 - ${diff.device}" 
                                             style="max-width: 200px; cursor: pointer;" 
                                             onclick="window.open('${diff.path}', '_blank')">
                                        <h4>差分 - ${diff.device}</h4>
                                        <p>${new Date(diff.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</p>
                                        <p>サイズ: ${(diff.size / 1024).toFixed(1)} KB</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="card">
                            <div class="result warning">
                                <h3>🔍 差分画像が見つかりません</h3>
                                <p>サイトID「${siteId}」の差分画像がありません。</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                displayError('差分画像一覧の取得に失敗しました: ' + error.message);
            }
        }

        // プラグイン更新ワークフロー関数
        async function takeBeforeUpdate() {
            const url = document.getElementById('url').value;
            const siteId = document.getElementById('siteId').value;
            const devices = Array.from(document.querySelectorAll('input[name="devices"]:checked')).map(cb => cb.value);
            
            if (!url || !siteId || devices.length === 0) {
                alert('URL、サイトID、デバイスを設定してください。');
                return;
            }
            
            showLoading(true);
            clearResults();
            
            try {
                const results = [];
                for (const device of devices) {
                    const res = await fetch('/screenshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, siteId, type: 'baseline', device })
                    });
                    const data = await res.json();
                    results.push({ device, ...data.result });
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="card">
                        <div class="result success">
                            <h3>✅ Step 1: 更新前キャプチャ完了</h3>
                            <p>プラグイン更新を実行してから「Step 2: 更新後キャプチャ」を実行してください。</p>
                        </div>
                        <div class="screenshot-grid">
                            ${results.map(result => `
                                <div class="screenshot-item">
                                    <h4>📱 ${result.device}</h4>
                                    <p><strong>ファイル:</strong> ${result.filename}</p>
                                    <p><strong>時刻:</strong> ${new Date(result.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                displayError('更新前キャプチャでエラーが発生しました: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function takeAfterUpdate() {
            const url = document.getElementById('url').value;
            const siteId = document.getElementById('siteId').value;
            const devices = Array.from(document.querySelectorAll('input[name="devices"]:checked')).map(cb => cb.value);
            
            if (!url || !siteId || devices.length === 0) {
                alert('URL、サイトID、デバイスを設定してください。');
                return;
            }
            
            showLoading(true);
            clearResults();
            
            try {
                const results = [];
                for (const device of devices) {
                    const res = await fetch('/screenshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, siteId, type: 'after', device })
                    });
                    const data = await res.json();
                    results.push({ device, ...data.result });
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="card">
                        <div class="result success">
                            <h3>✅ Step 2: 更新後キャプチャ完了</h3>
                            <p>「Step 3: 差分チェック」を実行して変更点を確認してください。</p>
                        </div>
                        <div class="screenshot-grid">
                            ${results.map(result => `
                                <div class="screenshot-item">
                                    <h4>📱 ${result.device}</h4>
                                    <p><strong>ファイル:</strong> ${result.filename}</p>
                                    <p><strong>時刻:</strong> ${new Date(result.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                displayError('更新後キャプチャでエラーが発生しました: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        

        function displayCrawlResults(results) {
            const totalPages = results.reduce((sum, r) => sum + r.totalPages, 0);
            
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>🕷️ クロール完了</h3>
                        <p><strong>対象サイト:</strong> ${results.length}サイト</p>
                        <p><strong>総ページ数:</strong> ${totalPages}ページ</p>
                    </div>
                    
                    ${results.map(result => `
                        <div class="diff-info">
                            <h4>🌐 ${result.siteName} (${result.siteId})</h4>
                            <p><strong>ベースURL:</strong> ${result.baseUrl}</p>
                            <p><strong>収集ページ数:</strong> ${result.totalPages}ページ</p>
                            <details>
                                <summary>ページ一覧を表示</summary>
                                <ul style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                    ${result.pages.map(page => 
                                        `<li><a href="${page.url}" target="_blank">${page.title}</a></li>`
                                    ).join('')}
                                </ul>
                            </details>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayStep1Results(results) {
            const allResults = results.flatMap(r => r.results || []);
            const totalSites = allResults.length;
            const totalPages = allResults.reduce((sum, r) => sum + r.captureCount, 0);
            
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>✅ Step1: Baseline撮影完了</h3>
                        <p><strong>実行サイト:</strong> ${totalSites}サイト</p>
                        <p><strong>総ページ数:</strong> ${totalPages}ページ</p>
                        <p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                            📝 <strong>次のステップ:</strong><br>
                            1. WordPressの管理画面でプラグイン更新を実行<br>
                            2. 上記フォームで「Step2+3: 撮影→即座に比較」を選択して実行
                        </p>
                    </div>
                    
                    ${results.map(deviceResult => `
                        <div class="diff-info">
                            <h4>📱 ${deviceResult.device} 結果</h4>
                            ${deviceResult.results.map(siteResult => `
                                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                    <h5>🌐 ${siteResult.siteName}</h5>
                                    <p><strong>撮影ページ:</strong> ${siteResult.captureCount}ページ</p>
                                    <p><strong>保存場所:</strong> screenshots/${siteResult.siteId}/</p>
                                    <details>
                                        <summary>撮影ページ一覧を表示</summary>
                                        <ul style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 0.9em;">
                                            ${siteResult.pages ? siteResult.pages.map(page => 
                                                `<li>${page.title || page.identifier}</li>`
                                            ).join('') : ''}
                                        </ul>
                                    </details>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayStep2And3Results(results) {
            const allResults = results.flatMap(r => r.results || []);
            const totalSites = allResults.length;
            const totalPages = allResults.reduce((sum, r) => sum + r.captureCount, 0);
            const ngSites = allResults.filter(r => 
                r.compareResults.summary ? r.compareResults.summary.ng > 0 : 
                r.compareResults.status === 'NG'
            ).length;
            
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result ${ngSites > 0 ? 'warning' : 'success'}">
                        <h3>${ngSites > 0 ? '⚠️' : '✅'} Step2+3統合実行完了</h3>
                        <p><strong>実行サイト:</strong> ${totalSites}サイト</p>
                        <p><strong>総ページ数:</strong> ${totalPages}ページ</p>
                        <p><strong>結果:</strong> OK: ${totalSites - ngSites}サイト, NG: ${ngSites}サイト</p>
                    </div>
                    
                    ${results.map(deviceResult => `
                        <div class="diff-info">
                            <h4>📱 ${deviceResult.device} 結果</h4>
                            ${deviceResult.results.map(siteResult => `
                                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                    <h5>🌐 ${siteResult.siteName}</h5>
                                    <p><strong>撮影ページ:</strong> ${siteResult.captureCount}ページ</p>
                                    ${siteResult.compareResults.summary ? `
                                        <p><strong>比較結果:</strong> 
                                            OK: ${siteResult.compareResults.summary.ok}, 
                                            NG: ${siteResult.compareResults.summary.ng}
                                        </p>
                                    ` : `
                                        <p><strong>比較結果:</strong> ${siteResult.compareResults.status}</p>
                                    `}
                                    <p><strong>闾値:</strong> ${siteResult.threshold}%</p>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayInfo(message) {
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result warning">
                        <h3>📝 情報</h3>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }

        // サイト管理関連関数
        function showSiteManager() {
            loadSitesList();
            document.getElementById('siteManagerModal').style.display = 'block';
        }

        function closeSiteManager() {
            document.getElementById('siteManagerModal').style.display = 'none';
        }

        async function loadSitesList() {
            const sitesListDiv = document.getElementById('sitesList');
            sitesListDiv.innerHTML = `
                ${allSites.map(site => `
                    <div style="padding: 10px; margin: 5px 0; background: ${site.enabled ? '#e8f5e8' : '#f5f5f5'}; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${site.name}</strong> (${site.id})<br>
                            <small>${site.baseUrl} - 最大${site.maxPages}ページ</small>
                        </div>
                        <div>
                            <button class="button ${site.enabled ? 'warning' : 'success'}" onclick="toggleSite('${site.id}')">
                                ${site.enabled ? '無効化' : '有効化'}
                            </button>
                            <button class="button secondary" onclick="deleteSite('${site.id}')">削除</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        async function addNewSite() {
            const siteId = document.getElementById('newSiteId').value;
            const siteName = document.getElementById('newSiteName').value;
            const siteUrl = document.getElementById('newSiteUrl').value;

            if (!siteId || !siteUrl) {
                alert('サイトIDとURLは必須です。');
                return;
            }

            try {
                const response = await fetch('/sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        siteId: siteId,
                        name: siteName || siteId,
                        baseUrl: siteUrl
                    })
                });

                const data = await response.json();
                if (data.success) {
                    await loadSites();
                    loadSitesList();
                    document.getElementById('newSiteId').value = '';
                    document.getElementById('newSiteName').value = '';
                    document.getElementById('newSiteUrl').value = '';
                    alert('サイトを追加しました。');
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('サイト追加エラー: ' + error.message);
            }
        }

        async function toggleSite(siteId) {
            try {
                const site = allSites.find(s => s.id === siteId);
                const response = await fetch(`/sites/${siteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !site.enabled })
                });

                const data = await response.json();
                if (data.success) {
                    await loadSites();
                    loadSitesList();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('サイト更新エラー: ' + error.message);
            }
        }

        async function deleteSite(siteId) {
            if (!confirm(`サイト ${siteId} を削除しますか？`)) {
                return;
            }

            try {
                const response = await fetch(`/sites/${siteId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadSites();
                    loadSitesList();
                    alert('サイトを削除しました。');
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('サイト削除エラー: ' + error.message);
            }
        }

        async function refreshSites() {
            await loadSites();
            alert('サイト一覧を更新しました。');
        }

        async function loadConfigFile() {
            const fileInput = document.getElementById('configFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ファイルを選択してください。');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                alert('JSONファイルを選択してください。');
                return;
            }
            
            try {
                const text = await file.text();
                const sites = JSON.parse(text);
                
                if (!Array.isArray(sites)) {
                    alert('ファイル形式が正しくありません。サイトの配列が必要です。');
                    return;
                }
                
                // ファイルをサーバーに送信
                const response = await fetch('/upload-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sites })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadSites();
                    alert(`${data.count}サイトの設定を読み込みました。サーバーを再起動すると永続化されます。`);
                    fileInput.value = '';
                } else {
                    alert('設定の読み込みに失敗しました: ' + data.error);
                }
                
            } catch (error) {
                alert('ファイルの読み込みでエラーが発生しました: ' + error.message);
            }
        }



        async function viewLatestSession(siteId, device) {
            showLoading(true);
            try {
                const response = await fetch(`/session-images/${siteId}/${device}`);
                const data = await response.json();
                
                if (data.success && data.images) {
                    displaySessionImages(data.images, siteId, device);
                } else {
                    displayError('セッション画像の取得に失敗しました: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                displayError('セッション画像の取得に失敗しました: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displaySessionImages(images, siteId, device) {
            const { baseline, after, comparisons } = images;
            
            // グローバル変数にデータを保存（テキスト出力用）
            currentSessionData = { baseline, after, comparisons, siteId, device };
            
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>📸 最新セッション画像一覧</h3>
                        <p><strong>サイト:</strong> ${siteId}</p>
                        <p><strong>デバイス:</strong> ${device}</p>
                        <p><strong>セッション日時:</strong> ${baseline.sessionTimestamp ? 
                            new Date(baseline.sessionTimestamp.replace(/-/g, ':')).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) : 
                            '不明'}</p>
                        <p><strong>ページ数:</strong> ${baseline.files.length}ページ</p>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                            <h4>🔍 表示フィルター</h4>
                            <div style="margin-top: 10px;">
                                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="diffFilter" value="all" onchange="applyDiffFilter()" checked style="margin-right: 8px; transform: scale(1.2);">
                                        <span style="font-weight: 500;">全ページ表示</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="diffFilter" value="ng-only" onchange="applyDiffFilter()" style="margin-right: 8px; transform: scale(1.2);">
                                        <span style="font-weight: 500; color: #dc3545;">NGページのみ</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="diffFilter" value="has-diff" onchange="applyDiffFilter()" style="margin-right: 8px; transform: scale(1.2);">
                                        <span style="font-weight: 500; color: #fd7e14;">差分があるページ（NG+OK軽微差分）</span>
                                    </label>
                                </div>
                                <span id="filterStatus" style="color: #666; font-size: 0.9em;">全${baseline.files.length}ページを表示中</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        ${baseline.files.map((baselineFile, index) => {
                            const afterFile = after.files[index];
                            const comparison = comparisons[index];
                            const pageNumber = index + 1;
                            
                            return `
                                <div class="diff-info page-comparison ${comparison && comparison.status === 'NG' ? 'has-diff ng-page' : (comparison && comparison.diffPercentage > 0 ? 'has-diff ok-page' : 'no-diff')}" style="margin-bottom: 30px;">
                                    <h4>📄 ページ ${pageNumber}: ${baselineFile.pageIdentifier || '不明'}</h4>
                                    
                                    ${comparison ? `
                                        <div style="margin: 15px 0; padding: 15px; background: ${comparison.status === 'NG' ? '#ffe6e6' : '#e6ffe6'}; border-radius: 6px;">
                                            <strong>比較結果:</strong> ${comparison.status} (差分率: ${comparison.diffPercentage}%)
                                            ${comparison.diffPath ? `
                                                <a href="${comparison.diffPath}" target="_blank" style="margin-left: 15px;">🔍 差分画像を見る</a>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                                        <div style="text-align: center;">
                                            <h5>🟢 更新前 (Baseline)</h5>
                                            <a href="${baselineFile.path}" target="_blank">
                                                <img src="${baselineFile.path}" alt="更新前" style="width: 100%; max-width: 500px; border: 2px solid #28a745; border-radius: 8px;">
                                            </a>
                                            <p style="margin-top: 5px; font-size: 0.9em; color: #666;">${baselineFile.filename}</p>
                                        </div>
                                        
                                        ${afterFile ? `
                                            <div style="text-align: center;">
                                                <h5>🔵 更新後 (After)</h5>
                                                <a href="${afterFile.path}" target="_blank">
                                                    <img src="${afterFile.path}" alt="更新後" style="width: 100%; max-width: 500px; border: 2px solid #007bff; border-radius: 8px;">
                                                </a>
                                                <p style="margin-top: 5px; font-size: 0.9em; color: #666;">${afterFile.filename}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${comparison && comparison.diffPath ? `
                                            <div style="text-align: center;">
                                                <h5>🔴 差分画像</h5>
                                                <a href="${comparison.diffPath}" target="_blank">
                                                    <img src="${comparison.diffPath}" alt="差分" style="width: 100%; max-width: 500px; border: 2px solid #dc3545; border-radius: 8px;">
                                                </a>
                                                <p style="margin-top: 5px; font-size: 0.9em; color: #666;">差分: ${comparison.diffPercentage}%</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>📋 比較結果テキスト出力</h4>
                        <div style="margin: 15px 0;">
                            <label style="margin-right: 20px;">
                                <input type="radio" name="textFilter" value="all" checked style="margin-right: 8px;">
                                全ページ
                            </label>
                            <label style="margin-right: 20px;">
                                <input type="radio" name="textFilter" value="ng-only" style="margin-right: 8px;">
                                NGページのみ
                            </label>
                            <label>
                                <input type="radio" name="textFilter" value="has-diff" style="margin-right: 8px;">
                                差分ありページ（NG+OK軽微差分）
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="button success" onclick="generateComparisonTextAdvanced()">📊 選択した結果をテキスト出力</button>
                            <button class="button secondary" onclick="downloadComparisonText()">💾 テキストファイルダウンロード</button>
                        </div>
                        <textarea id="comparisonTextOutput" 
                                  style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"
                                  placeholder="比較結果がここに表示されます..."
                                  readonly></textarea>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="button secondary" onclick="showResults()">🔙 結果一覧に戻る</button>
                    </div>
                </div>
            `;
        }

        async function showResults() {
            try {
                const response = await fetch('/results');
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    displayAllResults(data.results);
                } else {
                    displayInfo('📊 保存された結果はありません。');
                }
            } catch (error) {
                displayError('結果の取得に失敗しました: ' + error.message);
            }
        }

        function displayAllResults(results) {
            const totalSites = results.length;
            
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>📊 保存された実行結果</h3>
                        <p><strong>対象サイト:</strong> ${totalSites}サイト</p>
                    </div>
                    
                    ${results.map(site => `
                        <div class="diff-info">
                            <h4>🌐 ${site.siteName}</h4>
                            <p><strong>URL:</strong> ${site.baseUrl}</p>
                            
                            ${site.devices.map(device => `
                                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                    <h5>📱 ${device.device}</h5>
                                    
                                    ${device.baseline.latest ? `
                                        <div style="margin: 10px 0;">
                                            <strong>🟢 Baseline (更新前):</strong>
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>最新: ${new Date(device.baseline.latest.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</li>
                                                <li>総ファイル数: ${device.baseline.count}枚</li>
                                                ${device.baseline.sessions && device.baseline.sessions.length > 0 ? `
                                                    <li>セッション数: ${device.baseline.sessions.length}回
                                                        <details style="margin-top: 5px;">
                                                            <summary style="cursor: pointer; color: #667eea;">セッション詳細を表示</summary>
                                                            <ul style="margin-top: 5px; font-size: 0.9em;">
                                                                ${device.baseline.sessions.slice(0, 5).map(session => `
                                                                    <li>${new Date(session.sessionTimestamp.replace(/-/g, ':')).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })} - ${session.fileCount}枚</li>
                                                                `).join('')}
                                                                ${device.baseline.sessions.length > 5 ? '<li>...</li>' : ''}
                                                            </ul>
                                                        </details>
                                                    </li>
                                                ` : ''}
                                                <li><a href="${device.baseline.latest.path}" target="_blank" style="color: #667eea;">📸 最新画像を表示</a></li>
                                            </ul>
                                        </div>
                                    ` : '<p style="color: #666;">⚪ Baseline未撮影</p>'}
                                    
                                    ${device.after.latest ? `
                                        <div style="margin: 10px 0;">
                                            <strong>🔵 After (更新後):</strong>
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                <li>最新: ${new Date(device.after.latest.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}</li>
                                                <li>総ファイル数: ${device.after.count}枚</li>
                                                ${device.after.sessions && device.after.sessions.length > 0 ? `
                                                    <li>セッション数: ${device.after.sessions.length}回
                                                        <details style="margin-top: 5px;">
                                                            <summary style="cursor: pointer; color: #667eea;">セッション詳細を表示</summary>
                                                            <ul style="margin-top: 5px; font-size: 0.9em;">
                                                                ${device.after.sessions.slice(0, 5).map(session => `
                                                                    <li>${new Date(session.sessionTimestamp.replace(/-/g, ':')).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })} - ${session.fileCount}枚</li>
                                                                `).join('')}
                                                                ${device.after.sessions.length > 5 ? '<li>...</li>' : ''}
                                                            </ul>
                                                        </details>
                                                    </li>
                                                ` : ''}
                                                <li><a href="${device.after.latest.path}" target="_blank" style="color: #667eea;">📸 最新画像を表示</a></li>
                                            </ul>
                                        </div>
                                    ` : '<p style="color: #666;">⚪ After未撮影</p>'}
                                    
                                    ${device.hasBaseline && device.hasAfter ? `
                                        <p style="margin-top: 10px; color: #28a745;">✅ 比較可能</p>
                                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                                            <button class="button secondary" onclick="viewLatestSession('${site.siteId}', '${device.device}')" style="flex: 1;">
                                                📸 最新セッション表示
                                            </button>
                                        </div>
                                    ` : `
                                        <p style="margin-top: 10px; color: #dc3545;">❌ 比較不可（両方の撮影が必要）</p>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 初期値設定
        updateExecuteButtonText();

        // 既存の旧関数保持（下位互換性）
        async function takeBeforeUpdate() {
            displayInfo('⚙️ 旧ワークフロー関数です。新しいUIでStep2+3をご利用ください。');
        }
        
        async function takeAfterUpdate() {
            displayInfo('⚙️ 旧ワークフロー関数です。新しいUIでStep2+3をご利用ください。');
        }
        

        function displayFullVRTResults(data) {
            // 旧関数保持
            displayInfo('旧結果表示関数です。');
        }

        function displayComparisonResults(results) {
            // 旧関数保持
            displayInfo('旧結果表示関数です。');
        }

        function displayScreenshotResults(results, action) {
            // 旧関数保持
            displayInfo('旧結果表示関数です。');
        }

        function displayError(error) {
            document.getElementById('results').innerHTML = `
                <div class="card">
                    <div class="result error">
                        <h3>❌ エラーが発生しました</h3>
                        <p>${error}</p>
                    </div>
                </div>
            `;
        }

        async function loadScreenshots() {
            displayInfo('旧関数です。サイト管理で確認してください。');
        }

        async function loadDiffs() {
            displayInfo('旧関数です。サイト管理で確認してください。');
        }

        // グローバル変数に比較結果を保存
        let currentSessionData = null;

        // 新しい差分フィルター対応テキスト生成関数
        function generateComparisonTextAdvanced() {
            if (!currentSessionData) {
                alert('比較結果がありません。先にセッション画像を表示してください。');
                return;
            }
            
            // 選択されたフィルターオプション取得
            const selectedFilter = document.querySelector('input[name="diffTextFilter"]:checked').value;
            
            const { baseline, after, comparisons, siteId, device } = currentSessionData;
            let output = '';
            
            // ヘッダー
            output += `WordPress VRT 比較結果レポート\n`;
            output += `==========================================\n`;
            output += `サイト: ${siteId}\n`;
            output += `デバイス: ${device}\n`;
            output += `実行日時: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}\n`;
            output += `ベースライン: ${baseline.sessionTimestamp}\n`;
            output += `アフター: ${after.sessionTimestamp || '不明'}\n`;
            
            // フィルター情報
            const filterNames = {
                'all': '全ページ表示',
                'ng-only': 'NGページのみ',
                'has-diff': '差分があるページ（NG+OK軽微差分）'
            };
            output += `出力フィルター: ${filterNames[selectedFilter]}\n`;
            output += `==========================================\n\n`;
            
            // サマリー計算
            const totalPages = baseline.files.length;
            const ngPages = comparisons.filter(c => c && c.status === 'NG').length;
            const okPages = comparisons.filter(c => c && c.status === 'OK').length;
            const errorPages = comparisons.filter(c => !c).length;
            const hasDiffPages = comparisons.filter(c => c && parseFloat(c.diffPercentage) > 0).length;
            
            output += `📊 結果サマリー\n`;
            output += `総ページ数: ${totalPages}\n`;
            output += `OK: ${okPages}ページ\n`;
            output += `NG: ${ngPages}ページ\n`;
            output += `エラー: ${errorPages}ページ\n`;
            output += `差分あり: ${hasDiffPages}ページ\n\n`;
            
            // 詳細結果（フィルター適用）
            output += `📋 詳細結果 (${filterNames[selectedFilter]})\n`;
            output += `${'No.'.padEnd(4)} ${'ページID'.padEnd(25)} ${'判定'.padEnd(6)} ${'差分率'.padEnd(8)} ${'URL'}\n`;
            output += `${''.padEnd(80, '-')}\n`;
            
            let outputCount = 0;
            baseline.files.forEach((baselineFile, index) => {
                const comparison = comparisons[index];
                const pageNumber = (index + 1).toString().padStart(3, '0');
                const pageId = (baselineFile.pageIdentifier || '不明').padEnd(25);
                
                if (comparison) {
                    const status = comparison.status.padEnd(6);
                    const diffPercentage = `${comparison.diffPercentage}%`.padEnd(8);
                    const url = comparison.baselineUrl || baselineFile.path.replace('/screenshots/', '');
                    const hasDiff = parseFloat(comparison.diffPercentage) > 0;
                    
                    // フィルター条件適用
                    let shouldInclude = false;
                    switch (selectedFilter) {
                        case 'all':
                            shouldInclude = true;
                            break;
                        case 'ng-only':
                            shouldInclude = comparison.status === 'NG';
                            break;
                        case 'has-diff':
                            shouldInclude = hasDiff;
                            break;
                    }
                    
                    if (shouldInclude) {
                        output += `${pageNumber} ${pageId} ${status} ${diffPercentage} ${url}\n`;
                        outputCount++;
                    }
                } else {
                    // エラーは全ページ表示時のみ出力
                    if (selectedFilter === 'all') {
                        output += `${pageNumber} ${pageId} ERROR  ${'N/A'.padEnd(8)} エラーが発生しました\n`;
                        outputCount++;
                    }
                }
            });
            
            output += `\n表示件数: ${outputCount}件\n`;
            
            // NG/差分ページの詳細
            const showDetailPages = selectedFilter === 'ng-only' ? 
                comparisons.filter(c => c && c.status === 'NG') :
                selectedFilter === 'has-diff' ?
                comparisons.filter(c => c && parseFloat(c.diffPercentage) > 0) :
                comparisons.filter(c => c && c.status === 'NG');
            
            if (showDetailPages.length > 0) {
                output += `\n⚠️ 詳細情報\n`;
                output += `${''.padEnd(50, '=')}\n`;
                
                baseline.files.forEach((baselineFile, index) => {
                    const comparison = comparisons[index];
                    if (comparison) {
                        const shouldShow = selectedFilter === 'ng-only' ? 
                            comparison.status === 'NG' :
                            selectedFilter === 'has-diff' ?
                            parseFloat(comparison.diffPercentage) > 0 :
                            comparison.status === 'NG';
                        
                        if (shouldShow) {
                            const pageNumber = index + 1;
                            output += `\n📄 ページ ${pageNumber}: ${baselineFile.pageIdentifier}\n`;
                            output += `   判定: ${comparison.status}\n`;
                            output += `   差分率: ${comparison.diffPercentage}%\n`;
                            output += `   閾値: ${comparison.threshold}%\n`;
                            output += `   差分ピクセル数: ${comparison.diffPixels}\n`;
                            if (comparison.diffPath) {
                                output += `   差分画像: ${comparison.diffPath}\n`;
                            }
                        }
                    }
                });
            }
            
            output += `\n${''.padEnd(80, '=')}\n`;
            output += `レポート生成完了: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}\n`;
            
            document.getElementById('comparisonTextOutput').value = output;
        }
        
        // 旧関数の互換性維持
        function generateComparisonText(diffOnlyMode = false) {
            // 旧関数は新関数に転送し、フィルターを適用
            if (diffOnlyMode) {
                document.querySelector('input[name="diffTextFilter"][value="ng-only"]').checked = true;
            } else {
                document.querySelector('input[name="diffTextFilter"][value="all"]').checked = true;
            }
            generateComparisonTextAdvanced();
        }
        
        // テキストファイルダウンロード関数
        function downloadComparisonText() {
            const textOutput = document.getElementById('comparisonTextOutput').value;
            if (!textOutput) {
                alert('テキスト出力がありません。先に結果を生成してください。');
                return;
            }
            
            const blob = new Blob([textOutput], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vrt-comparison-result-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // サイト選択関連の関数
        function toggleAllSites() {
            const selectAllCheckbox = document.getElementById('selectAllSites');
            const siteCheckboxes = document.querySelectorAll('input[name="siteSelection"]');
            
            siteCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const siteCheckboxes = document.querySelectorAll('input[name="siteSelection"]:checked');
            const selectedCount = siteCheckboxes.length;
            const totalCount = document.querySelectorAll('input[name="siteSelection"]').length;
            
            document.getElementById('selectedSitesCount').textContent = `${selectedCount}/${totalCount}サイト選択中`;
            
            // 全選択チェックボックスの状態を更新
            const selectAllCheckbox = document.getElementById('selectAllSites');
            selectAllCheckbox.checked = selectedCount === totalCount;
            selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;
        }

        // 最終実行日を取得する関数（ローカルストレージから）
        function getLastExecutionDate(siteId) {
            const key = `vrt_last_execution_${siteId}`;
            return localStorage.getItem(key);
        }

        // 最終実行日を保存する関数
        function saveLastExecutionDate(siteId) {
            const key = `vrt_last_execution_${siteId}`;
            const now = new Date().toISOString();
            localStorage.setItem(key, now);
        }

        // 新しい差分フィルター適用関数
        function applyDiffFilter() {
            const selectedFilter = document.querySelector('input[name="diffFilter"]:checked').value;
            const pageComparisons = document.querySelectorAll('.page-comparison');
            const filterStatus = document.getElementById('filterStatus');
            
            if (!currentSessionData) return;
            
            let visibleCount = 0;
            let ngCount = 0;
            let hasDiffCount = 0;
            
            pageComparisons.forEach(page => {
                const isNG = page.classList.contains('ng-page');
                const hasDiff = page.classList.contains('has-diff');
                let shouldShow = false;
                
                if (isNG) ngCount++;
                if (hasDiff) hasDiffCount++;
                
                switch (selectedFilter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'ng-only':
                        shouldShow = isNG;
                        break;
                    case 'has-diff':
                        shouldShow = hasDiff;
                        break;
                }
                
                if (shouldShow) {
                    page.style.display = 'block';
                    visibleCount++;
                } else {
                    page.style.display = 'none';
                }
            });
            
            // ステータス更新
            const totalPages = currentSessionData.baseline.files.length;
            
            switch (selectedFilter) {
                case 'all':
                    filterStatus.textContent = `全${totalPages}ページを表示中`;
                    filterStatus.style.color = '#666';
                    break;
                case 'ng-only':
                    filterStatus.textContent = ngCount > 0 ? 
                        `NG判定 ${ngCount}件を表示中 (全${totalPages}ページ中)` : 
                        'NG判定のページはありません';
                    filterStatus.style.color = ngCount > 0 ? '#dc3545' : '#28a745';
                    break;
                case 'has-diff':
                    filterStatus.textContent = hasDiffCount > 0 ? 
                        `差分あり ${hasDiffCount}件を表示中 (全${totalPages}ページ中)` : 
                        '差分があるページはありません';
                    filterStatus.style.color = hasDiffCount > 0 ? '#fd7e14' : '#28a745';
                    break;
            }
        }
        
        // 旧関数の互換性維持
        function toggleDiffFilter() {
            applyDiffFilter();
        }
    </script>
</body>
</html>