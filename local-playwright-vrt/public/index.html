<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress VRT with Playwright</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.success {
            background: #28a745;
        }
        
        .button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .screenshot-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .screenshot-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .screenshot-item h4 {
            margin: 10px 0 5px;
            color: #333;
        }
        
        .screenshot-item p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .diff-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .diff-info h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .diff-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .diff-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .diff-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .diff-stat .label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .api-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .api-info h3 {
            margin-bottom: 15px;
            color: #1976d2;
        }
        
        .api-endpoint {
            background: #263238;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ WordPress VRT with Playwright</h1>
            <p>é«˜ç²¾åº¦ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã®è¦‹ãŸç›®å·®åˆ†æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div class="card">
            <h2>ğŸš€ VRTãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</h2>
            <form id="vrtForm">
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label for="url">ğŸ“ ã‚µã‚¤ãƒˆURL</label>
                            <input type="url" id="url" name="url" placeholder="https://example.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="siteId">ğŸ†” ã‚µã‚¤ãƒˆID</label>
                            <input type="text" id="siteId" name="siteId" placeholder="example-site" required>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label>ğŸ“± å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹</label>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" name="devices" value="desktop" checked>
                                    ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—
                                </label>
                                <label>
                                    <input type="checkbox" name="devices" value="mobile">
                                    ãƒ¢ãƒã‚¤ãƒ«
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="action">âš™ï¸ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰</label>
                            <select id="action" name="action">
                                <option value="full-vrt">ãƒ•ãƒ«VRTï¼ˆBaselineâ†’Afterâ†’æ¯”è¼ƒï¼‰</option>
                                <option value="baseline">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°å‰ï¼ˆBaselineæ’®å½±ï¼‰</option>
                                <option value="after">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°å¾Œï¼ˆAfteræ’®å½±ï¼‰</option>
                                <option value="compare">å·®åˆ†ãƒã‚§ãƒƒã‚¯ï¼ˆæ¯”è¼ƒã®ã¿ï¼‰</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="button">ğŸ¯ é¸æŠãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ</button>
                    <button type="button" class="button secondary" onclick="loadScreenshots()">ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç¢ºèª</button>
                    <button type="button" class="button warning" onclick="loadDiffs()">ğŸ” å·®åˆ†ç”»åƒç¢ºèª</button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <h3 style="margin-bottom: 15px; color: #555;">ğŸ”„ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button type="button" class="button success" onclick="takeBeforeUpdate()">
                            ğŸ“¸ Step 1: æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£
                        </button>
                        <div style="display: flex; align-items: center; padding: 10px 15px; background: #f8f9fa; border-radius: 6px; font-weight: 500;">
                            â†“ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°å®Ÿè¡Œ â†“
                        </div>
                        <button type="button" class="button success" onclick="takeAfterUpdate()">
                            ğŸ“¸ Step 2: æ›´æ–°å¾Œã‚­ãƒ£ãƒ—ãƒãƒ£
                        </button>
                        <button type="button" class="button warning" onclick="compareUpdates()">
                            ğŸ” Step 3: å·®åˆ†ãƒã‚§ãƒƒã‚¯
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>VRTãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...</p>
        </div>

        <div id="results"></div>

        <div class="api-info">
            <h3>ğŸ“š API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div class="api-endpoint">POST /screenshot - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±</div>
            <div class="api-endpoint">POST /compare - ç”»åƒæ¯”è¼ƒ</div>
            <div class="api-endpoint">POST /full-vrt - ãƒ•ãƒ«VRTãƒã‚§ãƒƒã‚¯</div>
            <div class="api-endpoint">GET /screenshots/:siteId - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§</div>
            <div class="api-endpoint">GET /diffs/:siteId - å·®åˆ†ç”»åƒä¸€è¦§</div>
        </div>
    </div>

    <script>
        const form = document.getElementById('vrtForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await executeVRT();
        });

        async function executeVRT() {
            const formData = new FormData(form);
            const url = formData.get('url');
            const siteId = formData.get('siteId');
            const action = formData.get('action');
            const devices = formData.getAll('devices');

            if (devices.length === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            showLoading(true);
            clearResults();

            try {
                let result;
                
                if (action === 'full-vrt') {
                    result = await fetch('/full-vrt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, siteId, devices })
                    });
                } else if (action === 'compare') {
                    // å„ãƒ‡ãƒã‚¤ã‚¹ã§æ¯”è¼ƒå®Ÿè¡Œ
                    const results = [];
                    for (const device of devices) {
                        const res = await fetch('/compare', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ siteId, device })
                        });
                        const data = await res.json();
                        results.push({ device, ...data.result });
                    }
                    displayComparisonResults(results);
                    return;
                } else {
                    // screenshotç³»ã®å‡¦ç†
                    const results = [];
                    for (const device of devices) {
                        const res = await fetch('/screenshot', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url, siteId, type: action, device })
                        });
                        const data = await res.json();
                        results.push({ device, ...data.result });
                    }
                    displayScreenshotResults(results, action);
                    return;
                }

                const data = await result.json();
                
                if (data.success) {
                    displayFullVRTResults(data.result);
                } else {
                    displayError(data.error);
                }

            } catch (error) {
                displayError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        function clearResults() {
            results.innerHTML = '';
        }

        function displayFullVRTResults(data) {
            const hasNG = data.summary && data.summary.ng > 0;
            const resultClass = hasNG ? 'warning' : 'success';
            
            results.innerHTML = `
                <div class="card">
                    <div class="result ${resultClass}">
                        <h3>ğŸ‰ ãƒ•ãƒ«VRTãƒã‚§ãƒƒã‚¯å®Œäº†</h3>
                        <p><strong>ã‚µã‚¤ãƒˆ:</strong> ${data.siteId}</p>
                        <p><strong>URL:</strong> ${data.url}</p>
                        <p><strong>åˆ¤å®š:</strong> ${hasNG ? 'âš ï¸ NGï¼ˆå·®åˆ†æ¤œå‡ºï¼‰' : 'âœ… OK'}</p>
                    </div>
                    
                    ${data.summary ? `
                    <div class="diff-info">
                        <h4>ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼</h4>
                        <div class="diff-stats">
                            <div class="diff-stat">
                                <div class="value">${data.summary.total}</div>
                                <div class="label">ç·ãƒ‡ãƒã‚¤ã‚¹æ•°</div>
                            </div>
                            <div class="diff-stat">
                                <div class="value">${data.summary.ok}</div>
                                <div class="label">OK</div>
                            </div>
                            <div class="diff-stat">
                                <div class="value">${data.summary.ng}</div>
                                <div class="label">NG</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${data.results ? data.results.map(result => `
                        <div class="diff-info">
                            <h4>ğŸ“± ${result.device} çµæœ</h4>
                            ${result.comparison ? `
                            <div class="diff-stats">
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.status}</div>
                                    <div class="label">åˆ¤å®š</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.diffPercentage}%</div>
                                    <div class="label">å·®åˆ†ç‡</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.comparison.diffPixels}</div>
                                    <div class="label">å·®åˆ†ãƒ”ã‚¯ã‚»ãƒ«</div>
                                </div>
                            </div>
                            ${result.comparison.diffPath ? `
                            <p><strong>å·®åˆ†ç”»åƒ:</strong> <a href="${result.comparison.diffPath}" target="_blank">è¡¨ç¤º</a></p>
                            ` : ''}
                            ` : ''}
                        </div>
                    `).join('') : ''}
                </div>
            `;
        }

        function displayComparisonResults(results) {
            const hasNG = results.some(r => r.status === 'NG');
            const resultClass = hasNG ? 'warning' : 'success';
            
            results.innerHTML = `
                <div class="card">
                    <div class="result ${resultClass}">
                        <h3>ğŸ” ç”»åƒæ¯”è¼ƒå®Œäº†</h3>
                        <p><strong>åˆ¤å®š:</strong> ${hasNG ? 'âš ï¸ NGï¼ˆå·®åˆ†æ¤œå‡ºï¼‰' : 'âœ… OK'}</p>
                    </div>
                    
                    ${results.map(result => `
                        <div class="diff-info">
                            <h4>ğŸ“± ${result.device} æ¯”è¼ƒçµæœ</h4>
                            <div class="diff-stats">
                                <div class="diff-stat">
                                    <div class="value">${result.status}</div>
                                    <div class="label">åˆ¤å®š</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.diffPercentage}%</div>
                                    <div class="label">å·®åˆ†ç‡</div>
                                </div>
                                <div class="diff-stat">
                                    <div class="value">${result.diffPixels}</div>
                                    <div class="label">å·®åˆ†ãƒ”ã‚¯ã‚»ãƒ«</div>
                                </div>
                            </div>
                            ${result.diffPath ? `
                            <p><strong>å·®åˆ†ç”»åƒ:</strong> <a href="${result.diffPath}" target="_blank">è¡¨ç¤º</a></p>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayScreenshotResults(results, action) {
            results.innerHTML = `
                <div class="card">
                    <div class="result success">
                        <h3>ğŸ“¸ ${action} æ’®å½±å®Œäº†</h3>
                        <p>${results.length}å€‹ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã¾ã—ãŸã€‚</p>
                    </div>
                    
                    <div class="screenshot-grid">
                        ${results.map(result => `
                            <div class="screenshot-item">
                                <h4>ğŸ“± ${result.device}</h4>
                                <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.filename}</p>
                                <p><strong>ã‚µã‚¤ã‚º:</strong> ${(result.size / 1024 / 1024).toFixed(2)} MB</p>
                                <p><strong>æ™‚åˆ»:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function displayError(error) {
            results.innerHTML = `
                <div class="card">
                    <div class="result error">
                        <h3>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p>${error}</p>
                    </div>
                </div>
            `;
        }

        async function loadScreenshots() {
            const siteId = document.getElementById('siteId').value;
            if (!siteId) {
                alert('ã‚µã‚¤ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const response = await fetch(`/screenshots/${siteId}`);
                const data = await response.json();
                
                if (data.screenshots && data.screenshots.length > 0) {
                    results.innerHTML = `
                        <div class="card">
                            <h3>ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§ (${siteId})</h3>
                            <div class="screenshot-grid">
                                ${data.screenshots.map(screenshot => `
                                    <div class="screenshot-item">
                                        <img src="${screenshot.path}" alt="${screenshot.type} - ${screenshot.device}" 
                                             style="max-width: 200px; cursor: pointer;" 
                                             onclick="window.open('${screenshot.path}', '_blank')">
                                        <h4>${screenshot.type} - ${screenshot.device}</h4>
                                        <p>${new Date(screenshot.timestamp).toLocaleString()}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="card">
                            <div class="result warning">
                                <h3>ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
                                <p>ã‚µã‚¤ãƒˆIDã€Œ${siteId}ã€ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                displayError('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function loadDiffs() {
            const siteId = document.getElementById('siteId').value;
            if (!siteId) {
                alert('ã‚µã‚¤ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const response = await fetch(`/diffs/${siteId}`);
                const data = await response.json();
                
                if (data.diffs && data.diffs.length > 0) {
                    results.innerHTML = `
                        <div class="card">
                            <h3>ğŸ” å·®åˆ†ç”»åƒä¸€è¦§ (${siteId})</h3>
                            <div class="screenshot-grid">
                                ${data.diffs.map(diff => `
                                    <div class="screenshot-item">
                                        <img src="${diff.path}" alt="å·®åˆ†ç”»åƒ - ${diff.device}" 
                                             style="max-width: 200px; cursor: pointer;" 
                                             onclick="window.open('${diff.path}', '_blank')">
                                        <h4>å·®åˆ† - ${diff.device}</h4>
                                        <p>${new Date(diff.timestamp).toLocaleString()}</p>
                                        <p>ã‚µã‚¤ã‚º: ${(diff.size / 1024).toFixed(1)} KB</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="card">
                            <div class="result warning">
                                <h3>ğŸ” å·®åˆ†ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
                                <p>ã‚µã‚¤ãƒˆIDã€Œ${siteId}ã€ã®å·®åˆ†ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                displayError('å·®åˆ†ç”»åƒä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–¢æ•°
        async function takeBeforeUpdate() {
            const url = document.getElementById('url').value;
            const siteId = document.getElementById('siteId').value;
            const devices = Array.from(document.querySelectorAll('input[name="devices"]:checked')).map(cb => cb.value);
            
            if (!url || !siteId || devices.length === 0) {
                alert('URLã€ã‚µã‚¤ãƒˆIDã€ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            showLoading(true);
            clearResults();
            
            try {
                const results = [];
                for (const device of devices) {
                    const res = await fetch('/screenshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, siteId, type: 'baseline', device })
                    });
                    const data = await res.json();
                    results.push({ device, ...data.result });
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="card">
                        <div class="result success">
                            <h3>âœ… Step 1: æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†</h3>
                            <p>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ŒStep 2: æ›´æ–°å¾Œã‚­ãƒ£ãƒ—ãƒãƒ£ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                        <div class="screenshot-grid">
                            ${results.map(result => `
                                <div class="screenshot-item">
                                    <h4>ğŸ“± ${result.device}</h4>
                                    <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.filename}</p>
                                    <p><strong>æ™‚åˆ»:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                displayError('æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function takeAfterUpdate() {
            const url = document.getElementById('url').value;
            const siteId = document.getElementById('siteId').value;
            const devices = Array.from(document.querySelectorAll('input[name="devices"]:checked')).map(cb => cb.value);
            
            if (!url || !siteId || devices.length === 0) {
                alert('URLã€ã‚µã‚¤ãƒˆIDã€ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            showLoading(true);
            clearResults();
            
            try {
                const results = [];
                for (const device of devices) {
                    const res = await fetch('/screenshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, siteId, type: 'after', device })
                    });
                    const data = await res.json();
                    results.push({ device, ...data.result });
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="card">
                        <div class="result success">
                            <h3>âœ… Step 2: æ›´æ–°å¾Œã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†</h3>
                            <p>ã€ŒStep 3: å·®åˆ†ãƒã‚§ãƒƒã‚¯ã€ã‚’å®Ÿè¡Œã—ã¦å¤‰æ›´ç‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                        <div class="screenshot-grid">
                            ${results.map(result => `
                                <div class="screenshot-item">
                                    <h4>ğŸ“± ${result.device}</h4>
                                    <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.filename}</p>
                                    <p><strong>æ™‚åˆ»:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                displayError('æ›´æ–°å¾Œã‚­ãƒ£ãƒ—ãƒãƒ£ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function compareUpdates() {
            const siteId = document.getElementById('siteId').value;
            const devices = Array.from(document.querySelectorAll('input[name="devices"]:checked')).map(cb => cb.value);
            
            if (!siteId || devices.length === 0) {
                alert('ã‚µã‚¤ãƒˆIDã¨ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            showLoading(true);
            clearResults();
            
            try {
                const results = [];
                for (const device of devices) {
                    const res = await fetch('/compare', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ siteId, device })
                    });
                    const data = await res.json();
                    results.push({ device, ...data.result });
                }
                
                const hasNG = results.some(r => r.status === 'NG');
                const resultClass = hasNG ? 'warning' : 'success';
                
                results.innerHTML = `
                    <div class="card">
                        <div class="result ${resultClass}">
                            <h3>${hasNG ? 'âš ï¸ Step 3: å·®åˆ†ã‚’æ¤œå‡ºã—ã¾ã—ãŸ' : 'âœ… Step 3: å·®åˆ†ãªã— - æ­£å¸¸'}</h3>
                            <p><strong>åˆ¤å®š:</strong> ${hasNG ? 'ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ã«ã‚ˆã‚Šè¦‹ãŸç›®ã®å¤‰åŒ–ãŒã‚ã‚Šã¾ã™' : 'ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ›´æ–°ã«ã‚ˆã‚‹è¦‹ãŸç›®ã®å¤‰åŒ–ã¯ã‚ã‚Šã¾ã›ã‚“'}</p>
                        </div>
                        
                        ${results.map(result => `
                            <div class="diff-info">
                                <h4>ğŸ“± ${result.device} æ¯”è¼ƒçµæœ</h4>
                                <div class="diff-stats">
                                    <div class="diff-stat">
                                        <div class="value" style="color: ${result.status === 'NG' ? '#dc3545' : '#28a745'}">${result.status}</div>
                                        <div class="label">åˆ¤å®š</div>
                                    </div>
                                    <div class="diff-stat">
                                        <div class="value">${result.diffPercentage}%</div>
                                        <div class="label">å·®åˆ†ç‡</div>
                                    </div>
                                    <div class="diff-stat">
                                        <div class="value">${result.diffPixels}</div>
                                        <div class="label">å·®åˆ†ãƒ”ã‚¯ã‚»ãƒ«</div>
                                    </div>
                                </div>
                                ${result.diffPath ? `
                                <p><strong>å·®åˆ†ç”»åƒ:</strong> <a href="${result.diffPath}" target="_blank" style="color: #667eea; text-decoration: none;">ğŸ“¸ å·®åˆ†ã‚’ç¢ºèª</a></p>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                displayError('å·®åˆ†ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆæœŸå€¤è¨­å®š
        document.getElementById('siteId').value = 'example-site';
        document.getElementById('url').value = 'https://example.com';
    </script>
</body>
</html>