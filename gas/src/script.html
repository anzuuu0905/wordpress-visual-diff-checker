<script>
// WordPress Visual Diff Checker - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ JavaScript

let sites = [];
let currentEditingSite = null;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  setupEventListeners();
});

/**
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
 */
function initializeApp() {
  loadSites();
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
 */
function setupEventListeners() {
  // ã‚µã‚¤ãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
  document.getElementById('addSiteForm').addEventListener('submit', handleAddSite);
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³
  document.getElementById('refreshBtn').addEventListener('click', loadSites);
  document.getElementById('healthCheckBtn').addEventListener('click', performHealthCheck);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
      closeModal();
      closeEditModal();
      closeConfirmModal();
    }
  });
  
  // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeModal();
      closeEditModal();
      closeConfirmModal();
    }
  });
}

/**
 * ã‚µã‚¤ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
 */
function loadSites() {
  showLoading();
  hideError();
  
  google.script.run
    .withSuccessHandler(handleLoadSitesSuccess)
    .withFailureHandler(handleLoadSitesError)
    .getSites();
}

/**
 * ã‚µã‚¤ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®å‡¦ç†
 */
function handleLoadSitesSuccess(data) {
  hideLoading();
  sites = data || [];
  displaySites();
}

/**
 * ã‚µã‚¤ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®å‡¦ç†
 */
function handleLoadSitesError(error) {
  hideLoading();
  showError('ã‚µã‚¤ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
}

/**
 * ã‚µã‚¤ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
 */
function displaySites() {
  const sitesBody = document.getElementById('sitesBody');
  const sitesContainer = document.getElementById('sitesContainer');
  const noSites = document.getElementById('noSites');
  
  if (sites.length === 0) {
    sitesContainer.style.display = 'block';
    noSites.style.display = 'block';
    sitesBody.innerHTML = '';
    return;
  }
  
  sitesContainer.style.display = 'block';
  noSites.style.display = 'none';
  
  sitesBody.innerHTML = sites.map(site => `
    <tr>
      <td>
        <div>
          <strong>${escapeHtml(site.name)}</strong>
          ${site.description ? `<br><small style="color: #666;">${escapeHtml(site.description)}</small>` : ''}
        </div>
      </td>
      <td>
        <a href="${escapeHtml(site.url)}" target="_blank" class="url-display" title="${escapeHtml(site.url)}">
          ${escapeHtml(site.url)}
        </a>
      </td>
      <td>
        <small>${site.lastRun || '-'}</small>
      </td>
      <td>
        <span class="status-badge status-${site.status}">
          ${getStatusDisplay(site.status)}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          ${getVrtButtons(site)}
          <button onclick="openEditModal('${site.id}')" class="btn btn-secondary btn-small">
            <span class="icon">âœï¸</span>
            ç·¨é›†
          </button>
          <button onclick="confirmDelete('${site.id}', '${escapeHtml(site.name)}')" class="btn btn-danger btn-small">
            <span class="icon">ğŸ—‘ï¸</span>
            å‰Šé™¤
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

/**
 * VRTãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
 * @param {Object} site - ã‚µã‚¤ãƒˆæƒ…å ±
 * @returns {string} HTMLæ–‡å­—åˆ—
 */
function getVrtButtons(site) {
  const isRunning = site.status === 'running';
  const hasBaseline = site.baselineStatus === 'completed';
  const baselineReady = site.baselineStatus === 'ready';
  
  if (isRunning) {
    return `
      <button class="btn btn-secondary btn-small" disabled>
        <span class="icon">â³</span>
        å®Ÿè¡Œä¸­...
      </button>
    `;
  }
  
  if (!hasBaseline && !baselineReady) {
    // åˆæœŸçŠ¶æ…‹: æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãƒœã‚¿ãƒ³ã®ã¿
    return `
      <button onclick="runPreUpdateCapture('${site.id}')" class="btn btn-primary btn-small">
        <span class="icon">ğŸ“¸</span>
        æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼
      </button>
    `;
  }
  
  if (hasBaseline || baselineReady) {
    // æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å®Œäº†å¾Œ: æ›´æ–°å¾Œæ¯”è¼ƒãƒœã‚¿ãƒ³ã¨å†ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãƒœã‚¿ãƒ³
    return `
      <div class="vrt-button-group">
        <button onclick="runPostUpdateCompare('${site.id}')" class="btn btn-primary btn-small">
          <span class="icon">ğŸ”</span>
          æ›´æ–°å¾Œæ¯”è¼ƒ
        </button>
        <button onclick="runPreUpdateCapture('${site.id}')" class="btn btn-secondary btn-small">
          <span class="icon">ğŸ“¸</span>
          å†ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼
        </button>
      </div>
    `;
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—¢å­˜ã®3ãƒœã‚¿ãƒ³ï¼‰
  return `
    <button onclick="runVrt('${site.id}', 'full')" class="btn btn-primary btn-small">
      <span class="icon">â–¶ï¸</span>
      å®Œå…¨å®Ÿè¡Œ
    </button>
  `;
}

/**
 * æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã®å®Ÿè¡Œ
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 */
function runPreUpdateCapture(siteId) {
  const site = sites.find(s => s.id === siteId);
  if (!site) return;
  
  showCaptureModal(site, 'pre-update');
}

/**
 * æ›´æ–°å¾Œæ¯”è¼ƒã®å®Ÿè¡Œ
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 */
function runPostUpdateCompare(siteId) {
  const site = sites.find(s => s.id === siteId);
  if (!site) return;
  
  showCaptureModal(site, 'post-update');
}

/**
 * ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
 * @param {Object} site - ã‚µã‚¤ãƒˆæƒ…å ±
 * @param {string} mode - 'pre-update' or 'post-update'
 */
function showCaptureModal(site, mode) {
  const modal = document.getElementById('captureModal');
  const titleElement = document.getElementById('captureModalTitle');
  const contentElement = document.getElementById('captureModalContent');
  
  if (mode === 'pre-update') {
    titleElement.textContent = 'æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼';
    contentElement.innerHTML = `
      <div class="capture-info">
        <h3>ğŸ“¸ ${escapeHtml(site.name)}</h3>
        <p class="capture-description">
          ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒ†ãƒ¼ãƒæ›´æ–°å‰ã®ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã—ã¾ã™ã€‚<br>
          ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å®Œäº†å¾Œã€æ‰‹å‹•ã§WordPressã®æ›´æ–°ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="capture-details">
          <p><strong>å¯¾è±¡URL:</strong> ${escapeHtml(site.url)}</p>
          <p><strong>å‡¦ç†æ™‚é–“:</strong> ç´„2-5åˆ†ï¼ˆã‚µã‚¤ãƒˆè¦æ¨¡ã«ã‚ˆã‚‹ï¼‰</p>
        </div>
        <div class="capture-actions">
          <button onclick="executePreUpdateCapture('${site.id}')" class="btn btn-primary">
            <span class="icon">ğŸ“¸</span>
            ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼é–‹å§‹
          </button>
          <button onclick="closeCaptureModal()" class="btn btn-secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      </div>
    `;
  } else {
    titleElement.textContent = 'æ›´æ–°å¾Œæ¯”è¼ƒ';
    contentElement.innerHTML = `
      <div class="capture-info">
        <h3>ğŸ” ${escapeHtml(site.name)}</h3>
        <p class="capture-description">
          æ›´æ–°å¾Œã®ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã—ã€æ›´æ–°å‰ã¨æ¯”è¼ƒã—ã¾ã™ã€‚<br>
          <strong>WordPressæ›´æ–°ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>
        </p>
        <div class="capture-details">
          <p><strong>å¯¾è±¡URL:</strong> ${escapeHtml(site.url)}</p>
          <p><strong>å‡¦ç†æ™‚é–“:</strong> ç´„3-7åˆ†ï¼ˆã‚µã‚¤ãƒˆè¦æ¨¡ã«ã‚ˆã‚‹ï¼‰</p>
          <p><strong>å‡¦ç†å†…å®¹:</strong> æ›´æ–°å¾Œã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ + å·®åˆ†æ¯”è¼ƒ + é€šçŸ¥</p>
        </div>
        <div class="manual-update-reminder">
          <div class="reminder-box">
            <span class="icon">âš ï¸</span>
            <div>
              <strong>é‡è¦:</strong> å®Ÿè¡Œå‰ã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>
              â€¢ WordPressãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ›´æ–°ãŒå®Œäº†ã—ã¦ã„ã‚‹<br>
              â€¢ ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹<br>
              â€¢ ç®¡ç†ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„
            </div>
          </div>
        </div>
        <div class="capture-actions">
          <button onclick="executePostUpdateCompare('${site.id}')" class="btn btn-primary">
            <span class="icon">ğŸ”</span>
            æ¯”è¼ƒé–‹å§‹
          </button>
          <button onclick="closeCaptureModal()" class="btn btn-secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      </div>
    `;
  }
  
  modal.style.display = 'block';
}

/**
 * ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeCaptureModal() {
  const modal = document.getElementById('captureModal');
  modal.style.display = 'none';
}

/**
 * æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã‚’å®Ÿè¡Œ
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 */
function executePreUpdateCapture(siteId) {
  closeCaptureModal();
  updateSiteStatus(siteId, 'running');
  
  google.script.run
    .withSuccessHandler(function(result) {
      handlePreUpdateCaptureSuccess(siteId, result);
    })
    .withFailureHandler(function(error) {
      handlePreUpdateCaptureError(siteId, error);
    })
    .runVrtCheck(siteId, 'baseline');
}

/**
 * æ›´æ–°å¾Œæ¯”è¼ƒã‚’å®Ÿè¡Œ
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 */
function executePostUpdateCompare(siteId) {
  closeCaptureModal();
  updateSiteStatus(siteId, 'running');
  
  google.script.run
    .withSuccessHandler(function(result) {
      handlePostUpdateCompareSuccess(siteId, result);
    })
    .withFailureHandler(function(error) {
      handlePostUpdateCompareError(siteId, error);
    })
    .runVrtCheck(siteId, 'after-and-compare');
}

/**
 * æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼æˆåŠŸæ™‚ã®å‡¦ç†
 */
function handlePreUpdateCaptureSuccess(siteId, result) {
  updateSiteStatus(siteId, 'ready');
  updateSiteBaselineStatus(siteId, 'completed');
  
  showNotification('âœ… æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
  showManualUpdateGuidance(siteId);
}

/**
 * æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å¤±æ•—æ™‚ã®å‡¦ç†
 */
function handlePreUpdateCaptureError(siteId, error) {
  updateSiteStatus(siteId, 'error');
  showNotification('âŒ æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
}

/**
 * æ›´æ–°å¾Œæ¯”è¼ƒæˆåŠŸæ™‚ã®å‡¦ç†
 */
function handlePostUpdateCompareSuccess(siteId, result) {
  updateSiteStatus(siteId, 'completed');
  
  const hasChanges = result.summary && result.summary.totalChanges > 0;
  const notificationTitle = hasChanges ? 
    'âš ï¸ å·®åˆ†ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ' : 
    'âœ… å·®åˆ†ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
  
  showNotification(notificationTitle, hasChanges ? 'warning' : 'success');
  showResultModal(result);
}

/**
 * æ›´æ–°å¾Œæ¯”è¼ƒå¤±æ•—æ™‚ã®å‡¦ç†
 */
function handlePostUpdateCompareError(siteId, error) {
  updateSiteStatus(siteId, 'error');
  showNotification('âŒ æ›´æ–°å¾Œæ¯”è¼ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
}

/**
 * æ‰‹å‹•æ›´æ–°ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’è¡¨ç¤º
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 */
function showManualUpdateGuidance(siteId) {
  const site = sites.find(s => s.id === siteId);
  if (!site) return;
  
  const modal = document.getElementById('guidanceModal');
  const contentElement = document.getElementById('guidanceModalContent');
  
  contentElement.innerHTML = `
    <div class="guidance-content">
      <h3>ğŸ“¸ ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å®Œäº†</h3>
      <p class="guidance-description">
        <strong>${escapeHtml(site.name)}</strong> ã®æ›´æ–°å‰ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
      </p>
      
      <div class="next-steps">
        <h4>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:</h4>
        <ol>
          <li>WordPressç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</li>
          <li>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã™ã‚‹</li>
          <li>ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹</li>
          <li>ä¸‹ã®ã€Œæ›´æ–°å¾Œæ¯”è¼ƒã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</li>
        </ol>
      </div>
      
      <div class="guidance-actions">
        <button onclick="closeGuidanceModal()" class="btn btn-primary">
          ç¢ºèªã—ã¾ã—ãŸ
        </button>
        <button onclick="runPostUpdateCompare('${site.id}'); closeGuidanceModal();" class="btn btn-secondary">
          ã™ãã«æ¯”è¼ƒå®Ÿè¡Œ
        </button>
      </div>
    </div>
  `;
  
  modal.style.display = 'block';
}

/**
 * ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeGuidanceModal() {
  const modal = document.getElementById('guidanceModal');
  modal.style.display = 'none';
}

/**
 * ã‚µã‚¤ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 * @param {string} status - æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 */
function updateSiteStatus(siteId, status) {
  const site = sites.find(s => s.id === siteId);
  if (site) {
    site.status = status;
    displaySites();
  }
}

/**
 * ã‚µã‚¤ãƒˆã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
 * @param {string} siteId - ã‚µã‚¤ãƒˆID
 * @param {string} baselineStatus - æ–°ã—ã„ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³çŠ¶æ…‹
 */
function updateSiteBaselineStatus(siteId, baselineStatus) {
  const site = sites.find(s => s.id === siteId);
  if (site) {
    site.baselineStatus = baselineStatus;
    displaySites();
  }
}

/**
 * é€šçŸ¥ã‚’è¡¨ç¤º
 * @param {string} message - é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {string} type - é€šçŸ¥ã‚¿ã‚¤ãƒ— ('success', 'error', 'warning', 'info')
 */
function showNotification(message, type = 'info') {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toastIcon');
  const toastMessage = document.getElementById('toastMessage');
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  toastIcon.textContent = icons[type] || icons.info;
  toastMessage.textContent = message;
  
  toast.className = `toast toast-${type}`;
  toast.style.display = 'block';
  
  // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
  setTimeout(() => {
    toast.style.display = 'none';
  }, 5000);
}

/**
 * æ–°ã—ã„ã‚µã‚¤ãƒˆã‚’è¿½åŠ 
 */
function handleAddSite(e) {
  e.preventDefault();
  
  const name = document.getElementById('siteName').value.trim();
  const url = document.getElementById('siteUrl').value.trim();
  const description = document.getElementById('siteDescription').value.trim();
  
  if (!name || !url) {
    showToast('ã‚µã‚¤ãƒˆåã¨URLã¯å¿…é ˆã§ã™', 'error');
    return;
  }
  
  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="icon">â³</span> è¿½åŠ ä¸­...';
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('ã‚µã‚¤ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        document.getElementById('addSiteForm').reset();
        loadSites();
      } else {
        showToast(result.error || 'ã‚µã‚¤ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚µã‚¤ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .withFinish(function() {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="icon">â•</span> ã‚µã‚¤ãƒˆã‚’è¿½åŠ ';
    })
    .addSite(name, url, description);
}

/**
 * VRT ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
 */
function runVrt(siteId, mode) {
  const site = sites.find(s => s.id === siteId);
  if (!site) {
    showToast('ã‚µã‚¤ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  // å®Ÿè¡Œç¢ºèª
  const modeNames = {
    full: 'å®Œå…¨å®Ÿè¡Œï¼ˆBaseline â†’ After â†’ æ¯”è¼ƒï¼‰',
    baseline: 'Baseline å®Ÿè¡Œ',
    after: 'After å®Ÿè¡Œ',
    compare: 'æ¯”è¼ƒå®Ÿè¡Œ'
  };
  
  if (!confirm(`${site.name} ã® ${modeNames[mode]} ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\nå®Ÿè¡Œã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`)) {
    return;
  }
  
  // UI ã‚’æ›´æ–°
  updateSiteStatus(siteId, 'running');
  showToast(`${site.name} ã® ${modeNames[mode]} ã‚’é–‹å§‹ã—ã¾ã—ãŸ`, 'success');
  
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast(`${site.name} ã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ`, 'success');
        showResultModal(result);
      } else {
        showToast(`å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
      }
      loadSites(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    })
    .withFailureHandler(function(error) {
      showToast(`å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      loadSites(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    })
    .runVrtCheck(siteId, mode);
}

/**
 * ã‚µã‚¤ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
 */
function updateSiteStatus(siteId, status) {
  const site = sites.find(s => s.id === siteId);
  if (site) {
    site.status = status;
    displaySites();
  }
}

/**
 * ã‚µã‚¤ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
 */
function openEditModal(siteId) {
  const site = sites.find(s => s.id === siteId);
  if (!site) return;
  
  currentEditingSite = site;
  
  document.getElementById('editSiteId').value = site.id;
  document.getElementById('editSiteName').value = site.name;
  document.getElementById('editSiteUrl').value = site.url;
  document.getElementById('editSiteDescription').value = site.description || '';
  
  document.getElementById('editModal').style.display = 'flex';
}

/**
 * ã‚µã‚¤ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  currentEditingSite = null;
}

/**
 * ã‚µã‚¤ãƒˆæƒ…å ±ã‚’æ›´æ–°
 */
function updateSite() {
  const siteId = document.getElementById('editSiteId').value;
  const name = document.getElementById('editSiteName').value.trim();
  const url = document.getElementById('editSiteUrl').value.trim();
  const description = document.getElementById('editSiteDescription').value.trim();
  
  if (!name || !url) {
    showToast('ã‚µã‚¤ãƒˆåã¨URLã¯å¿…é ˆã§ã™', 'error');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('ã‚µã‚¤ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        closeEditModal();
        loadSites();
      } else {
        showToast(result.error || 'ã‚µã‚¤ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚µã‚¤ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .updateSite(siteId, name, url, description);
}

/**
 * ã‚µã‚¤ãƒˆå‰Šé™¤ã®ç¢ºèª
 */
function confirmDelete(siteId, siteName) {
  showConfirmModal(
    'ã‚µã‚¤ãƒˆå‰Šé™¤ã®ç¢ºèª',
    `ã€Œ${siteName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`,
    function() {
      deleteSite(siteId);
    }
  );
}

/**
 * ã‚µã‚¤ãƒˆã‚’å‰Šé™¤
 */
function deleteSite(siteId) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('ã‚µã‚¤ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        loadSites();
      } else {
        showToast(result.error || 'ã‚µã‚¤ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚µã‚¤ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .deleteSite(siteId);
  
  closeConfirmModal();
}

/**
 * çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
 */
function showResultModal(result) {
  const content = document.getElementById('resultContent');
  
  let html = `
    <div class="progress-steps">
      <div class="result-summary">
        <h4>${result.siteName} ã®å®Ÿè¡Œçµæœ</h4>
        <p><strong>å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰:</strong> ${result.mode}</p>
        <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> ${new Date(result.startTime).toLocaleString('ja-JP')} ã€œ ${new Date(result.endTime).toLocaleString('ja-JP')}</p>
        ${result.ngCount !== undefined ? `<p><strong>æ¤œå‡ºã•ã‚ŒãŸå·®åˆ†:</strong> ${result.ngCount} ä»¶</p>` : ''}
      </div>
  `;
  
  if (result.steps && result.steps.length > 0) {
    html += '<h5>å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—:</h5>';
    result.steps.forEach(step => {
      const stepNames = {
        baseline: 'Baseline ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ',
        after: 'After ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ', 
        compare: 'å·®åˆ†æ¯”è¼ƒ'
      };
      
      html += `
        <div class="progress-step ${step.status}">
          <span class="step-icon">
            ${step.status === 'completed' ? 'âœ…' : step.status === 'running' ? 'â³' : 'âŒ'}
          </span>
          <div class="step-details">
            <div class="step-name">${stepNames[step.step] || step.step}</div>
            <div class="step-time">
              ${step.startTime ? new Date(step.startTime).toLocaleTimeString('ja-JP') : ''} 
              ${step.endTime ? ' ã€œ ' + new Date(step.endTime).toLocaleTimeString('ja-JP') : ''}
            </div>
          </div>
        </div>
      `;
    });
  }
  
  if (result.error) {
    html += `
      <div class="progress-step error">
        <span class="step-icon">âŒ</span>
        <div class="step-details">
          <div class="step-name">ã‚¨ãƒ©ãƒ¼</div>
          <div class="step-time">${result.error}</div>
        </div>
      </div>
    `;
  }
  
  html += '</div>';
  content.innerHTML = html;
  
  document.getElementById('resultModal').style.display = 'flex';
}

/**
 * çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeModal() {
  document.getElementById('resultModal').style.display = 'none';
}

/**
 * Google Sheets ã‚’é–‹ã
 */
function openSheets() {
  const sheetId = 'YOUR_SHEET_ID'; // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  window.open(`https://docs.google.com/spreadsheets/d/${sheetId}`, '_blank');
}

/**
 * ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
 */
function showConfirmModal(title, message, onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  document.getElementById('confirmAction').onclick = onConfirm;
  document.getElementById('confirmModal').style.display = 'flex';
}

/**
 * ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
}

/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
 */
function performHealthCheck() {
  const btn = document.getElementById('healthCheckBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="icon">â³</span> ãƒã‚§ãƒƒã‚¯ä¸­...';
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.cloudRunStatus === 'healthy' || result.cloudRunStatus === 'ok') {
        showToast('ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™', 'success');
      } else {
        showToast('Cloud Run ã«æ¥ç¶šã§ãã¾ã›ã‚“', 'warning');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .withFinish(function() {
      btn.disabled = false;
      btn.innerHTML = '<span class="icon">ğŸ’š</span> ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯';
    })
    .healthCheck();
}

/**
 * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
 */
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const messageEl = document.getElementById('toastMessage');
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸',
    info: 'â„¹ï¸'
  };
  
  toast.className = `toast ${type}`;
  icon.textContent = icons[type] || icons.success;
  messageEl.textContent = message;
  
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 5000);
}

/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
 */
function showLoading() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('sitesContainer').style.display = 'none';
  document.getElementById('error').style.display = 'none';
}

/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
 */
function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

/**
 * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
 */
function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('error').style.display = 'block';
  document.getElementById('sitesContainer').style.display = 'none';
}

/**
 * ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
 */
function hideError() {
  document.getElementById('error').style.display = 'none';
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºåã‚’å–å¾—
 */
function getStatusDisplay(status) {
  const statusMap = {
    pending: 'å¾…æ©Ÿä¸­',
    running: 'å®Ÿè¡Œä¸­',
    completed: 'å®Œäº†',
    ok: 'æ­£å¸¸',
    ng: 'å·®åˆ†ã‚ã‚Š',
    error: 'ã‚¨ãƒ©ãƒ¼'
  };
  
  return statusMap[status] || status;
}

/**
 * HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * å®šæœŸçš„ãªã‚µã‚¤ãƒˆä¸€è¦§æ›´æ–°ï¼ˆå®Ÿè¡Œä¸­ã®ã‚‚ã®ãŒã‚ã‚‹å ´åˆï¼‰
 */
function startPeriodicUpdate() {
  setInterval(() => {
    const runningSites = sites.filter(site => site.status === 'running');
    if (runningSites.length > 0) {
      loadSites();
    }
  }, 30000); // 30ç§’é–“éš”
}

// å®šæœŸæ›´æ–°é–‹å§‹
startPeriodicUpdate();
</script>